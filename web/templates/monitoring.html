{{template "base.html" .}}
{{define "title"}}Resource Monitoring{{end}}
{{define "content"}}
<div class="container">
    <h1>üìä Resource Monitoring</h1>
    
    <!-- Real-time Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>üñ•Ô∏è CPU</h3>
            <div class="progress-ring" id="cpu-ring">
                <svg viewBox="0 0 36 36">
                    <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    <path class="progress" id="cpu-progress" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                </svg>
                <span id="cpu-value">0%</span>
            </div>
            <p><span id="cpu-cores">0</span> Cores</p>
        </div>
        
        <div class="stat-card">
            <h3>üß† Memory</h3>
            <div class="progress-ring" id="mem-ring">
                <svg viewBox="0 0 36 36">
                    <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    <path class="progress" id="mem-progress" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                </svg>
                <span id="mem-value">0%</span>
            </div>
            <p><span id="mem-used">0</span> / <span id="mem-total">0</span> GB</p>
        </div>
        
        <div class="stat-card">
            <h3>üíæ Disk</h3>
            <div class="progress-ring" id="disk-ring">
                <svg viewBox="0 0 36 36">
                    <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    <path class="progress" id="disk-progress" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                </svg>
                <span id="disk-value">0%</span>
            </div>
            <p><span id="disk-used">0</span> / <span id="disk-total">0</span> GB</p>
        </div>
        
        <div class="stat-card">
            <h3>‚è±Ô∏è Uptime</h3>
            <div class="uptime-display">
                <span id="uptime">0h 0m</span>
            </div>
        </div>
    </div>
    
    <!-- Period Selector -->
    <div class="period-selector">
        <button class="period-btn active" data-period="5m">5 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
        <button class="period-btn" data-period="15m">15 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
        <button class="period-btn" data-period="30m">30 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
        <button class="period-btn" data-period="1h">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</button>
    </div>
    
    <!-- Charts -->
    <div class="chart-container">
        <h3>üìà CPU Usage</h3>
        <canvas id="cpuChart"></canvas>
    </div>
    
    <div class="chart-container">
        <h3>üìà Memory Usage</h3>
        <canvas id="memChart"></canvas>
    </div>
    
    <div class="chart-container">
        <h3>üìà Disk Usage</h3>
        <canvas id="diskChart"></canvas>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.stat-card h3 {
    margin-bottom: 15px;
    color: #fff;
}

.progress-ring {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto;
}

.progress-ring svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.progress-ring .bg {
    fill: none;
    stroke: #3a3a3a;
    stroke-width: 3;
}

.progress-ring .progress {
    fill: none;
    stroke: #4CAF50;
    stroke-width: 3;
    stroke-linecap: round;
    transition: stroke-dasharray 0.5s ease;
}

.progress-ring span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: bold;
    color: #fff;
}

.uptime-display {
    font-size: 32px;
    color: #4CAF50;
    padding: 30px 0;
}

.period-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    justify-content: center;
}

.period-btn {
    padding: 10px 20px;
    background: #2a2a2a;
    border: none;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s;
}

.period-btn:hover, .period-btn.active {
    background: #4CAF50;
}

.chart-container {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.chart-container h3 {
    margin-bottom: 15px;
    color: #fff;
}

.chart-container canvas {
    width: 100% !important;
    height: 200px !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Charts
let cpuChart, memChart, diskChart;
let currentPeriod = '5m';

// Initialize charts
function initCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                grid: { color: '#3a3a3a' },
                ticks: { color: '#999' }
            },
            x: {
                grid: { color: '#3a3a3a' },
                ticks: { color: '#999' }
            }
        },
        plugins: {
            legend: { display: false }
        }
    };
    
    cpuChart = new Chart(document.getElementById('cpuChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#4CAF50', tension: 0.4, fill: true, backgroundColor: 'rgba(76, 175, 80, 0.1)' }] },
        options: chartOptions
    });
    
    memChart = new Chart(document.getElementById('memChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#2196F3', tension: 0.4, fill: true, backgroundColor: 'rgba(33, 150, 243, 0.1)' }] },
        options: chartOptions
    });
    
    diskChart = new Chart(document.getElementById('diskChart'), {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#FF9800', tension: 0.4, fill: true, backgroundColor: 'rgba(255, 152, 0, 0.1)' }] },
        options: chartOptions
    });
}

// Update progress rings
function updateRing(id, percent) {
    const progress = document.getElementById(id + '-progress');
    const value = document.getElementById(id + '-value');
    progress.style.strokeDasharray = `${percent}, 100`;
    value.textContent = percent.toFixed(1) + '%';
    
    // Change color based on usage
    let color = '#4CAF50';
    if (percent > 80) color = '#f44336';
    else if (percent > 60) color = '#FF9800';
    progress.style.stroke = color;
}

// Format bytes
function formatBytes(bytes) {
    return (bytes / (1024 * 1024 * 1024)).toFixed(1);
}

// Fetch realtime data
async function fetchRealtime() {
    try {
        const res = await fetch('/api/resource/realtime');
        const data = await res.json();
        
        updateRing('cpu', data.cpu_percent);
        updateRing('mem', data.mem_percent);
        updateRing('disk', data.disk_percent);
        
        document.getElementById('cpu-cores').textContent = data.cpu_cores;
        document.getElementById('mem-used').textContent = formatBytes(data.mem_used);
        document.getElementById('mem-total').textContent = formatBytes(data.mem_total);
        document.getElementById('disk-used').textContent = formatBytes(data.disk_used);
        document.getElementById('disk-total').textContent = formatBytes(data.disk_total);
        document.getElementById('uptime').textContent = data.uptime;
    } catch (e) {
        console.error('Error fetching realtime data:', e);
    }
}

// Fetch history data
async function fetchHistory() {
    try {
        const res = await fetch('/api/resource/history?period=' + currentPeriod);
        const data = await res.json();
        
        if (data.data && data.data.length > 0) {
            const labels = data.data.map(d => new Date(d.timestamp).toLocaleTimeString());
            const cpuData = data.data.map(d => d.cpu_percent);
            const memData = data.data.map(d => d.mem_percent);
            const diskData = data.data.map(d => d.disk_percent);
            
            cpuChart.data.labels = labels;
            cpuChart.data.datasets[0].data = cpuData;
            cpuChart.update();
            
            memChart.data.labels = labels;
            memChart.data.datasets[0].data = memData;
            memChart.update();
            
            diskChart.data.labels = labels;
            diskChart.data.datasets[0].data = diskData;
            diskChart.update();
        }
    } catch (e) {
        console.error('Error fetching history:', e);
    }
}

// Period selector
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.dataset.period;
        fetchHistory();
    });
});

// Initialize
initCharts();
fetchRealtime();
fetchHistory();

// Update every 5 seconds
setInterval(fetchRealtime, 5000);
setInterval(fetchHistory, 10000);
</script>
{{end}}
